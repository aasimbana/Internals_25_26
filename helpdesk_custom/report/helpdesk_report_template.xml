<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <!-- PDF Document Template -->
    <template id="report_helpdesk_pdf_document">
        <t t-call="web.external_layout">
            <main class="page">
                <h2 style="text-align:center;">Helpdesk Report</h2>

                <!-- Show date range below the title -->
                <div style="text-align: center; margin-bottom: 15px; font-style: italic; color: #666;">
                    <t t-if="data.get('start_date', '') != 'N/A' or data.get('end_date', '') != 'N/A'">
                        Period: 
                        <t t-if="data.get('start_date', '') != 'N/A'">
                            from <t t-esc="data.get('start_date', '')"/>
                        </t>
                        <t t-if="data.get('end_date', '') != 'N/A'">
                            to <t t-esc="data.get('end_date', '')"/>
                        </t>
                    </t>
                    <t t-else="">
                        Period: All dates
                    </t>
                </div>

                <table style="width:100%; border-collapse:collapse;" class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th style="border:1px solid #999; padding:4px; background-color:#D9E1F2;">
                                STATE / TECHNICIAN
                            </th>
                            <!-- Technician headers -->
                            <t t-foreach="data.get('employees', [])" t-as="emp">
                                <th style="border:1px solid #999; padding:4px; text-align:center; background-color:#D9E1F2;">
                                    <t t-esc="emp.get('name','')"/>
                                </th>
                            </t>
                            <th style="border:1px solid #999; padding:4px; text-align:center; background-color:#D9E1F2;">
                                TOTAL STATE
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows per state -->
                        <t t-set="states_ordered" t-value="[s for s in data.get('states', []) if s != 'Ninguno'] + ['Ninguno']"/>
                        <t t-foreach="states_ordered" t-as="state">
                            <tr>
                                <td style="border:1px solid #999; padding:4px; background-color:#FCE4D6;">
                                    <t t-esc="state"/>
                                </td>
                                <!-- Count per technician -->
                                <t t-foreach="data.get('employees', [])" t-as="emp">
                                    <td style="border:1px solid #999; padding:4px; text-align:center;">
                                        <t t-esc="data.get('count', {}).get(state, {}).get(emp.get('name',''), 0)"/>
                                    </td>
                                </t>
                                <!-- Total per state -->
                                <td style="border:1px solid #999; padding:4px; text-align:center; font-weight:bold; background-color:#BDD7EE;">
                                    <t t-esc="sum(data.get('count', {}).get(state, {}).values())"/>
                                </td>
                            </tr>
                        </t>

                        <!-- TOTAL PER TECHNICIAN row -->
                        <tr>
                            <td style="border:1px solid #999; padding:4px; font-weight:bold; background-color:#BDD7EE;">
                                TOTAL PER TECHNICIAN
                            </td>
                            <t t-foreach="data.get('employees', [])" t-as="emp">
                                <td style="border:1px solid #999; padding:4px; text-align:center; font-weight:bold; background-color:#BDD7EE;">
                                    <t t-esc="data.get('total_per_technician', {}).get(emp.get('name',''), 0)"/>
                                </td>
                            </t>
                            <td style="border:1px solid #999; padding:4px; text-align:center; font-weight:bold; background-color:#FFC000;">
                                <t t-esc="data.get('total_general', 0)"/>
                            </td>
                        </tr>

                        <!-- TOTAL GENERAL row (merged) -->
                        <tr>
                            <td t-att-colspan="len(data.get('employees', [])) + 2"
                                style="border:1px solid #999; padding:6px; text-align:center; font-weight:bold; background-color:#FFB300;">
                                TOTAL GENERAL: <t t-esc="data.get('total_general', 0)"/>
                            </td>
                        </tr>

                        <!-- Report generation date -->
                        <tr>
                            <td t-att-colspan="len(data.get('employees', [])) + 2"
                                style="border:1px solid #999; padding:4px; text-align:center; font-style:italic; color:#666; background-color:#f9f9f9;">
                                Report generated on <t t-esc="data.get('generation_date', '')"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </main>
        </t>
    </template>

    <!-- Container template -->
    <template id="report_helpdesk_pdf">
        <t t-call="web.html_container">
            <t t-call="helpdesk_custom.report_helpdesk_pdf_document"/>
        </t>
    </template>

</odoo>
